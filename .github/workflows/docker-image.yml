name: Docker Image CI

# 监听master分支
# on:
#   push:
#     branches:
#       - master

on:
  push:
    tags:
      - v*

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Build the Docker image
        env:
          aliyun_username: ${{ secrets.ALIYUN_USERNAME }}
          aliyun_password: ${{ secrets.ALIYUN_PASSWORD }}
          version: ${{github.ref:10}}
        run: |
          echo version: ${version}
          cat .env.example >> .env
          sudo docker login --username=${aliyun_username} registry.cn-chengdu.aliyuncs.com --password=${aliyun_password}
          sudo docker build -t api:${version} .
          sudo docker tag api:latest registry.cn-chengdu.aliyuncs.com/bookkeeping-01/api:${version}
          sudo docker push registry.cn-chengdu.aliyuncs.com/bookkeeping-01/api:${version}
